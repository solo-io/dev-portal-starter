"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");
exports.__esModule = true;
exports.default = void 0;
var _apidomCore = require("@swagger-api/apidom-core");
var _selector = _interopRequireDefault(require("./selector.cjs"));
var _accessor = _interopRequireDefault(require("./accessor.cjs"));
var _requirementLevel = require("./requirement-level.cjs");
const makeMessage = (value, requirementLevel, standardIdentifier) => {
  const primitiveValue = value.toValue();
  const primitiveStandardIdentifier = JSON.stringify(standardIdentifier.toValue());
  if (requirementLevel.toValue() === 'may') {
    return `"${primitiveValue}" not allowed for subject ${primitiveStandardIdentifier}`;
  }
  throw new Error('Not Implemented');
};

// @ts-ignore
const makeAnnotation = (message, value, level, standardIdentifier) => {
  const annotation = new _apidomCore.AnnotationElement(message);
  annotation.classes.push(level);
  annotation.attributes.set('value', value.clone());
  annotation.attributes.set('standardIdentifier', standardIdentifier.clone());
  return annotation;
};
const validateValue = (value, requirement) => {
  const annotations = [];
  const {
    subject
  } = requirement;
  if (typeof requirement.values === 'undefined') return annotations;
  if (requirement.level.toValue() === 'may') {
    const isValid = (0, _requirementLevel.may)(value.toValue(), requirement.values.toValue());
    if (!isValid) {
      const message = makeMessage(value, requirement.level, subject);
      const annotation = makeAnnotation(message, value, 'error', subject);
      annotations.push(annotation);
    }
  }
  return annotations;
};
const validateRequirement = (requirement, selected) => {
  const {
    subject
  } = requirement;
  const values = (0, _accessor.default)(selected, subject);
  const annotations = [];
  values.forEach(value => {
    annotations.push(...validateValue(value, requirement));
  });
  return annotations;
};
const validateScenario = (scenario, openApiElement) => {
  const annotations = [];
  const {
    when
  } = scenario;
  const selected = (0, _selector.default)(openApiElement, when);
  const {
    then: requirements
  } = scenario;
  if (typeof requirements === 'undefined') return annotations;
  selected.forEach(item => {
    // @ts-ignore
    requirements.forEach(requirement => {
      annotations.push(...validateRequirement(requirement, item));
    });
  });
  return annotations;
};
const validate = (mainElement, openApiElement) => {
  const {
    scenarios
  } = mainElement;
  const annotations = [];
  if (typeof scenarios === 'undefined' || !(0, _apidomCore.isArrayElement)(scenarios)) return [];

  // @ts-ignore
  scenarios.forEach(scenario => {
    annotations.push(...validateScenario(scenario, openApiElement));
  });
  return annotations;
};
var _default = validate;
exports.default = _default;